# Oracle Automation Roadmap

Last updated: 2026-02-18
Owner: Copilot + project maintainers
Scope: rules-engine Oracle text intent parsing/execution reliability and coverage

## Objective

Increase deterministic Oracle-text automation so the engine executes more card intent correctly with minimal skips, while refusing unsafe/ambiguous actions.

## Application-Level Alignment

This roadmap supports the broader MTGEDH goal:
- Multiplayer Commander gameplay with strong rules fidelity.
- Real-time reliability for up to 8 players.
- Less manual bookkeeping via safe automation.

## Milestone Model (3 Layers)

### Layer 1 — Reliability Foundation (short-term)
Goal: Make current automation paths robust against malformed context and multiplayer ambiguity.

Milestones:
- M1.1 Canonical context normalization across trigger/adapter/executor.
- M1.2 Deterministic selector binding precedence and sanitization.
- M1.3 Invalid-context safety (never over-resolve targets).
- M1.4 Regression guardrails for precedence/sanitization matrices.

Exit criteria:
- Shared normalization path used by major trigger/stack execution flows.
- Ambiguous target selectors skip safely rather than mis-target.
- Focused test suites + typecheck consistently green.

### Layer 2 — Coverage Expansion (mid-term)
Goal: Increase the percentage of Oracle templates that execute end-to-end without manual intervention.

Milestones:
- M2.1 Expand deterministic selector support (player/object/group patterns).
- M2.2 Broaden trigger/event hint derivation from runtime payloads.
- M2.3 Add parser coverage for frequent real-card phrasing variants.
- M2.4 Add integration tests for event->stack->resolution chains.

Exit criteria:
- More common Commander card templates execute automatically.
- New parser/executor additions ship with regression tests.
- No increase in false-positive executions.

### Layer 3 — Interaction Fidelity (long-term)
Goal: Improve correctness for complex interactions while preserving deterministic behavior.

Milestones:
- M3.1 Deepen intervening-if and condition-gated resolution handling.
- M3.2 Improve APNAP-sensitive and multiplayer edge sequencing.
- M3.3 Strengthen stack metadata continuity from source event to final resolution.
- M3.4 Add confidence reporting/telemetry for skipped vs applied effect paths.

Exit criteria:
- Complex multiplayer interactions are handled with predictable outcomes.
- Skip reasons are explicit and traceable.
- Fidelity improvements do not regress baseline reliability.

## Current Status Snapshot

Status key: `done`, `in-progress`, `not-started`, `blocked`

| ID | Milestone | Status | Notes |
|---|---|---|---|
| M1.1 | Canonical normalization pipeline | done | Shared trigger/stack context builders integrated. |
| M1.2 | Deterministic selector precedence | done | Explicit > inferred singleton > base fallback enforced in tests. |
| M1.3 | Invalid-context safety | done | Controller/opponent sanitization and malformed-ID hardening added. |
| M1.4 | Reliability regression guardrails | done | Matrix tests + focused adapter/trigger/executor regressions in place. |
| M2.1 | Deterministic selector expansion | done | Selector-context hardening completed for singleton/relational multiplayer cases across parser/executor/adapter. |
| M2.2 | Runtime hint derivation breadth | done | Trigger/event hint normalization unified across cast/activate/resolve paths, including legacy target shaping. |
| M2.3 | Oracle phrasing coverage | done | Added deterministic support for `its controller` selector phrasing (including possessive library forms) across parser/executor paths with regressions. |
| M2.4 | End-to-end chain integration tests | done | Added cast/activate and legacy stack event->stack->resolution regressions for target and relational contexts. |
| M3.1 | Intervening-if fidelity expansion | done | Opponent-control condition classes broadened with threshold handling across creatures/artifacts/enchantments/lands/planeswalkers/permanents, with direct tests. |
| M3.2 | APNAP/multiplayer edge sequencing | done | APNAP ordering now covers turn-order wrap-around and active-missing fallback behaviors, validated by regression matrix tests. |
| M3.3 | Stack metadata continuity | done | Canonical metadata shaping now covers primary and legacy stack resolution paths. |
| M3.4 | Skip/apply confidence telemetry | done | Trigger flow now exposes counters and emits structured telemetry summary logs for executions/applied/skipped paths. |

## Working Backlog (Next Up)

No uncovered milestone-critical items remain from the current roadmap pass.

Follow-up (non-blocking hardening):
1. Continue opportunistic parser template expansion for newly observed corpus phrasing variants.
2. Consider legacy `AutomationService` stack item modernization to align with canonical trigger metadata patterns used in active adapter/trigger pipelines.

## Update Protocol

When a milestone changes state:
1. Update `Last updated` date.
2. Change milestone status in **Current Status Snapshot**.
3. Add one line in **Milestone Change Log** with evidence (tests or typecheck command).

## Milestone Change Log

- 2026-02-16: Initialized roadmap with 3-layer model and baseline status mapped to current implementation progress.
- 2026-02-16: Hardened direct-context selector normalization for player + battlefield controller filters (including invalid/whitespace controller handling) and added regressions; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Normalized move-zone controller usage in `applyOracleIRStepsToGameState` (including each-opponent zone traversals and your-zone transfers) and added whitespace-controller regressions; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened each-opponent move-zone execution to require a valid controller in current state (prevents malformed-controller over-resolution to all players) and added regression coverage; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened resolution event-data fallback to avoid fabricating `lifeTotal=0` when controller lookup fails (prevents false life-threshold condition matches), with regression coverage in `triggerParsing.test.ts`; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened resolution turn-state derivation to require a valid controller before computing `isYourTurn`/`isOpponentsTurn` (prevents false turn-condition matches under malformed controller context) while preserving explicit base fallback flags; added regressions in `triggerParsing.test.ts` and validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Tightened trigger target inference so generic `targetId`/`targetIds` cannot pollute `targetPlayerId`/`targetOpponentId` bindings (object/permanent IDs no longer misclassified as player targets), with regressions in `triggerParsing.test.ts`; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Tightened `affectedPlayerIds` fallback to player-scoped target fields only (excluding generic `targetIds` noise), and preserved multiplayer targeted stack resolution by explicitly threading selected target bindings into spell/ability stack metadata in `RulesEngineAdapter`; added regressions in `triggerParsing.test.ts` and validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened multi-target semantics by enforcing singleton-only scalar inference for `targetPlayerId`/`targetOpponentId` across trigger normalization and hint adaptation (multi-opponent sets remain relational), plus adapter fallback updates to pass selected target sets while only scalar-binding singleton selections; added multiplayer ambiguity regressions in `RulesEngineAdapter.test.ts` and validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Unified singleton+relational target shaping in stack-resolution compatibility paths by converting raw legacy `targets` into `affectedPlayerIds`/`affectedOpponentIds` before normalization in `resolveStack`; added legacy stack regressions for singleton-target bind + multi-target ambiguity in `RulesEngineAdapter.test.ts`, validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Completed broad confidence pass after normalization/targeting hardening by running full rules-engine suite (`vitest run`, 97 files / 2894 tests passing) plus `npm run typecheck --workspace=rules-engine`; no regressions detected beyond focused coverage.
- 2026-02-16: Completed cross-workspace integration check via root `npm run build` (server TypeScript build + client Vite production build succeeded), confirming recent rules-engine hardening does not break monorepo build pipeline.
- 2026-02-16: Hardened draw-trigger event shaping in `checkDrawTriggers` to avoid premature opponent sanitization against the drawing player and to thread explicit drawing-target fields; added regression coverage in `triggersHandler.test.ts` and validated with focused suite (`triggersHandler.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Added pronoun-target support for follow-up templates (`that player`, `that opponent`, plus `he or she`/`they`) in Oracle IR parsing and deterministic selector mapping, with executor regressions and draw-trigger integration validation (`triggersHandler.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded pronoun-target deterministic coverage across additional verbs (`draw`, `discard`, `mill`, `lose_life`) with executor regressions to ensure `that player/that opponent` bindings consistently resolve via selector context; validated with focused suite (`oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`, `RulesEngineAdapter.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded adapter integration coverage for pronoun-target templates by adding full cast/activate -> stack -> resolve regressions for `That player loses 1 life.` in multiplayer, confirming stack metadata/hint propagation resolves pronoun targets correctly; validated with focused suite (`RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Added singleton-safety ambiguity regressions for pronoun templates in adapter stack flows (multi-target `That player ...` spell/ability cases do not auto-bind a first target), validating no first-target collapse under plural target sets; focused suite (`RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine` remains green.
- 2026-02-16: Final consolidation checkpoint after pronoun-template and ambiguity hardening: full rules-engine suite rerun clean (`vitest run`, 97 files / 2904 tests) with `npm run typecheck --workspace=rules-engine` also clean.
- 2026-02-16: Extended pronoun-target support to raw damage target resolution (`deals ... to that player/that opponent/he or she/they`) and added deterministic executor regressions, validated with focused suite (`oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`, `RulesEngineAdapter.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Added trigger confidence telemetry fields (`oracleStepsSkipped`, `oracleExecutions`) to `TriggerResult` and regression coverage for applied vs skipped deterministic execution paths in `triggersHandler.test.ts`; focused suite + typecheck green.
- 2026-02-16: Implemented full APNAP ranking with multiplayer turn-order input in `putTriggersOnStack` (beyond active/non-active split), wired turn-order forwarding from `processTriggers`, and added APNAP ordering regression in `triggerParsing.test.ts`; focused suite + typecheck green.
- 2026-02-16: Post-milestone broad verification rerun clean (`vitest run`, 97 files / 2908 tests) with `npm run typecheck --workspace=rules-engine` clean.
- 2026-02-16: Expanded opponent-control intervening-if evaluation in `evaluateOpponentControlCondition` to support count thresholds and additional permanent classes (`X or more creatures/artifacts/enchantments/permanents` plus enchantment/permanent presence), with direct condition regressions added in `triggerParsing.test.ts`; validated by focused suite (`triggerParsing.test.ts`, `triggersHandler.test.ts`, `oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, 367 tests passing) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Further expanded opponent-control condition classes to include `land` and `planeswalker` (including `X or more ...` thresholds) in `evaluateOpponentControlCondition`; added regressions in `triggerParsing.test.ts` and validated with focused suite (`triggerParsing.test.ts`, `triggersHandler.test.ts`, `oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, 368 tests passing) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded deterministic selector phrasing coverage for `its controller` across parser/executor paths (including possessive library forms like `its controller's` and raw damage-target text), with parser + executor regressions (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`); validated via focused suite (`triggerParsing.test.ts`, `triggersHandler.test.ts`, `oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, 587 tests passing) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded APNAP sequencing regression matrix with turn-order wrap-around and active-player-missing fallback cases in `triggerParsing.test.ts`, and surfaced trigger telemetry summaries in logs (`[triggers] Oracle auto-execution: executions=..., applied=..., skipped=...`) with regression in `triggersHandler.test.ts`; validated via focused suite + typecheck, then full-suite confidence pass clean (`vitest run`, 97 files / 2914 tests) with `npm run typecheck --workspace=rules-engine` clean.
- 2026-02-16: Completed non-player selector normalization parity hardening by normalizing battlefield permanent controller IDs in object selector filtering (`you` / `opponents`) and rejecting malformed controller IDs for controller-scoped matches; added regressions in `oracleIRExecutor.test.ts` (whitespace controller IDs + malformed-controller exclusion) and validated with focused suite (`RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`, 373 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite confidence rerun clean (`vitest run`, 97 files / 2916 tests).
- 2026-02-16: Added missing support for previously unsupported multi-sentence combat-damage trigger effects by preserving full same-line trigger effect text in `parseTriggeredAbilitiesFromText` (instead of truncating at first period), enabling relational exile-top trigger execution in `dealCombatDamage` adapter flow; added regressions in `triggerParsing.test.ts` and `RulesEngineAdapter.test.ts`, validated with focused suite (`triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggersHandler.test.ts`, 375 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2918 tests).
- 2026-02-16: Expanded missing trigger-parser support further to preserve multiline trigger effect bodies until the next trigger header (while still splitting adjacent trigger headers correctly), covering newline-separated effect continuations in real oracle layouts; added regressions in `triggerParsing.test.ts`, validated with focused suite (`triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggersHandler.test.ts`, 377 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2920 tests).
- 2026-02-16: Added deterministic `its owner` selector support across parser/executor paths (`parsePlayerSelector`, exile-until subject parsing, possessive library source mapping, and raw damage-target resolution), enabling context-bound player resolution for owner-referential phrasings; updated parser expectation and added executor regression in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 594 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2921 tests).
- 2026-02-16: Added missing deterministic coverage for the `its owner may exile ... from the top of their library` parser branch (including possessive source variants in create+exile split parsing), so owner-referential exile-top templates bind `target_player` consistently instead of falling through to unknown; added parser regression in `oracleIRParser.test.ts` and executor regression in `oracleIRExecutor.test.ts`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 596 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2923 tests).
- 2026-02-16: Closed residual owner-possessive gaps in the large exile-top parsing path by adding `its owner's`/`its controller's` source support consistently across direct exile, variable-amount exile, and `put ... into exile` variants (including contextual `each of those opponents` branch adjacency); added regression in `oracleIRParser.test.ts` for `that many ... from the top of its owner's library`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 597 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2924 tests).
- 2026-02-16: Expanded deterministic antecedent-controller phrasing support to include `that creature's controller` / `that permanent's controller` / `that card's controller` across parser selector mapping, impulse-exile subject parsing (including exile-until variants), and raw damage-target resolution in executor; added parser regression in `oracleIRParser.test.ts` and executor regression in `oracleIRExecutor.test.ts`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 599 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2926 tests).
- 2026-02-16: Completed antecedent-owner phrasing parity by adding deterministic support for `that creature's owner` / `that permanent's owner` / `that card's owner` across parser selector mapping, impulse-exile subject parsing branches, and executor raw damage-target resolution; added parser regression in `oracleIRParser.test.ts` and executor regression in `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2928 tests).
- 2026-02-16: Expanded antecedent phrase regression coverage to include additional deterministic variants already supported in code (`that creature's owner`, `that card's owner`, `that card's controller`) across parser and raw damage-target executor paths; added parser and executor regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2932 tests).
- 2026-02-16: Closed the remaining complementary antecedent regression pair by adding parser coverage for `that card's owner` impulse-exile subject mapping and executor raw-damage target coverage for `that card's controller`; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2934 tests).
- 2026-02-16: Generalized antecedent owner/controller selector handling from fixed noun lists to `that <object>'s owner/controller` pattern matching across parser selector mapping, impulse-exile subject branches, and executor raw damage target resolution; added regressions for `that artifact's controller` (`oracleIRParser.test.ts`) and `that enchantment's owner` (`oracleIRExecutor.test.ts`), validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2936 tests).
- 2026-02-16: Added deterministic pronoun-synonym support for `him or her` by normalizing it to existing `he or she` parser paths and extending raw damage target resolution to bind it as `target_player`; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2938 tests).
- 2026-02-16: Added missing relational raw-damage target support for `each of those opponents` in executor damage target resolution (binding to `each_of_those_opponents` selector context), with regression coverage in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2939 tests).
- 2026-02-16: Extended mixed deterministic damage target parsing to support relational `each of those opponents` player groups (e.g. `each creature and each of those opponents`) by threading `each_of_those_opponents` through mixed-target execution; added focused regression in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2940 tests).
- 2026-02-16: Added relational selector alias support for bare `those opponents` / `all of those opponents` across parser normalization, player-selector mapping, raw damage target resolution, and mixed deterministic damage target parsing; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2942 tests).
- 2026-02-16: Closed possessive relational alias gap in exile-top parsing by supporting `those opponents'` / `all of those opponents'` source forms (plus `each of those opponents'`) in the primary single-clause and impulse-exile parser branches, enabling deterministic `each_of_those_opponents` binding for both `Exile ... of ... libraries` and `Put ... into exile` templates; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2944 tests).
- 2026-02-16: Extended face-down combined look+exile parsing to accept relational possessive source aliases (`those opponents'` / `all of those opponents'` / `each of those opponents'`) and map them to `each_of_those_opponents`, enabling deterministic relational execution for templates like `Look at the top card of those opponents' libraries and exile those cards face down`; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2946 tests).
- 2026-02-16: Generalized two-clause face-down look+exile parsing to support both legacy singular (`top card ... exile it`) and quantified/plural object forms (`top N cards ... exile those cards`), while adding relational possessive source aliases (`those opponents'` / `all of those opponents'` / `each of those opponents'`) with `each_of_those_opponents` binding; added parser + executor regressions for `Look at the top card of those opponents' libraries, then exile those cards face down ...`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2948 tests).
- 2026-02-16: Added explicit alias regression coverage for `all of those opponents` / `all of those opponents'` across selector parsing, possessive exile-top parsing, and executor relational resolution (`deal_damage` + `exile_top`) to lock parity with existing `those opponents` handling; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2952 tests).
- 2026-02-16: Reduced parser drift risk by centralizing relational alias detection into `isThoseOpponentsSelector` / `isThoseOpponentsPossessiveSource` helpers and replacing duplicated inline `startsWith(...)` chains across exile-top and face-down parsing branches (no behavior change intended); validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2952 tests).
- 2026-02-16: Extended relational alias regression coverage to include the compact `all those opponents` player phrase and mixed-target phrasing `each creature and all of those opponents` in executor deterministic damage paths, plus parser selector coverage for `all those opponents`; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2955 tests).
- 2026-02-17: Extended parser support for exile-until subject aliases by accepting relational variants (`each of those opponents` / `those opponents` / `all of those opponents` / `all those opponents`) in the `... exiles cards from the top of their library until ...` branch and mapping them to `each_of_those_opponents`; added parser regressions for `each of those opponents` + `all those opponents` exile-until templates, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2957 tests).
- 2026-02-17: Completed exile-until alias parity coverage by adding parser regressions for the remaining relational subject variants (`those opponents` and `all of those opponents`) in `... exiles cards from the top of their library until ...` templates, ensuring all supported alias forms are lock-tested; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2959 tests).
- 2026-02-17: Reduced executor drift risk by centralizing relational alias checks into `isThoseOpponentsSelector(...)` and replacing duplicated inline string checks in deterministic damage-target parsing (`resolvePlayersFromDamageTarget`, `parseDeterministicMixedDamageTarget`) with no intended behavior change; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2959 tests).
- 2026-02-17: Expanded deterministic raw damage-target support to treat `defending player` / `the defending player` as `target_opponent` in `resolvePlayersFromDamageTarget`, with focused regressions added in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2961 tests).
- 2026-02-17: Extended mixed deterministic damage-target parsing/execution to treat `defending player` / `the defending player` (and context-bound singleton aliases like `that player` / `that opponent`) as valid player parts when combined with battlefield selectors (for example, `each creature and defending player`), with regressions added in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2963 tests).
- 2026-02-17: Added explicit mixed-target regression coverage for context-bound singleton player aliases `that player` and `that opponent` (e.g., `each creature and that player`) in `oracleIRExecutor.test.ts` to lock deterministic mixed parsing/execution parity with direct damage-target handling; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2965 tests).
- 2026-02-17: Closed non-damage defending-player gap by extending player-selector parsing and gain/lose-life subject matching to accept `defending player` / `the defending player` as `target_opponent`, with executor regressions for `Defending player loses 1 life.` and `The defending player loses 1 life.` in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2967 tests).
- 2026-02-17: Extended draw subject parsing to accept `defending player` / `the defending player` in deterministic player-subject draw templates, enabling target-opponent context binding for `Defending player draws a card.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2969 tests).
- 2026-02-17: Extended mill subject parsing to accept `defending player` / `the defending player` in deterministic player-subject mill templates, enabling target-opponent context binding for `Defending player mills a card.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2971 tests).
- 2026-02-17: Extended discard subject parsing to accept `defending player` / `the defending player` across deterministic discard patterns (`discards ...`, `discards ... hand`, `discards all cards in ... hand`), enabling target-opponent context binding for `Defending player discards a card.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2973 tests).
- 2026-02-17: Extended `scry`/`surveil` subject parsing to accept `defending player` / `the defending player` in deterministic player-subject templates, and added executor regressions that validate target-opponent context binding in no-choice empty-library cases (`Defending player scries 1.` / `The defending player surveils 1.`); validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2975 tests).
- 2026-02-17: Extended deterministic `add_mana` subject parsing to accept `defending player` / `the defending player`, enabling target-opponent context binding for templates like `Defending player adds {G}.`; added executor regressions in `oracleIRExecutor.test.ts` and validated with focused parser+executor suites (`vitest test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2977 tests).
- 2026-02-17: Extended deterministic `sacrifice` subject parsing to accept `defending player` / `the defending player`, enabling target-opponent context binding for templates like `Defending player sacrifices a creature.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2979 tests).
- 2026-02-17: Extended deterministic `create_token` subject parsing to accept `defending player` / `the defending player` in both single-token and multi-token parser branches, enabling target-opponent context binding for templates like `Defending player creates a Treasure token.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2981 tests).
- 2026-02-17: Extended impulse exile subject parsing to accept `defending player` / `the defending player` in third-person `... may exile ... from the top of their library` and `... exiles cards from the top ... until ...` branches (including both primary and pending-upgrade parser paths), with parser regressions in `oracleIRParser.test.ts`; validated with focused parser+executor suites (`vitest test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2983 tests).
- 2026-02-17: Added possessive-source normalization for `the defending player's` phrasing in clause preprocessing (mapped to `target opponent's`) so deterministic exile-top/impulse templates bind `target_opponent` across parser paths without branch drift; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2985 tests).
- 2026-02-17: Extended subject-order deterministic exile-top parsing to accept `defending player` / `the defending player` in `... exiles the top card(s) of their library` and `... puts the top card(s) of their library into exile` branches (in both primary and fallback parse paths), and switched those branch mappings to `parsePlayerSelector(...)` to reduce selector drift; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2987 tests).
- 2026-02-17: Closed standalone face-down relational alias drift in `tryParseExileTopOnly` by extending `look at the top ... and exile ... face down` source matching to include `each of those opponents'` / `those opponents'` / `all of those opponents'` / `all those opponents'` and mapping those forms to `each_of_those_opponents`; added parser + executor regressions for the standalone no-permission template in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2989 tests).
- 2026-02-17: Closed split-clause face-down impulse drift by expanding the 2-clause `look at the top card ...` + `then exile ... face down` parser path to accept relational possessive aliases (`each of those opponents'` / `those opponents'` / `all of those opponents'` / `all those opponents'`) and plural second-clause refs (`them` / `those cards` / `the cards`), mapping relational forms to `each_of_those_opponents`; added parser + executor regressions for the split-clause template in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2991 tests).
- 2026-02-17: Extended the split-clause face-down impulse path to support quantified look clauses (`look at the top N cards ... . Then exile those cards face down ...`) while preserving deterministic selector binding for target-opponent and relational sources; added parser + executor regressions for the top-two split-clause template in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2993 tests).
- 2026-02-17: Added standalone no-permission regression coverage for split-clause quantified face-down exile (`look at the top N cards ... . Then exile those cards face down.`) to lock parity between `impulse_exile_top` and `exile_top` parsing/execution paths; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2995 tests).
- 2026-02-17: Expanded split-clause top-N look+exile parsing parity to also accept no-face-down second clauses (`Then exile those cards.`) in both impulse-upgrade and standalone no-permission paths, preventing parser drift between `impulse_exile_top` and `exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2999 tests).
- 2026-02-17: Closed remaining single-clause look+exile drift by allowing combined templates to parse with or without `face down` in both impulse-upgrade (`look ... and exile ... . You may play ...`) and standalone no-permission (`look ... and exile ...`) paths, preserving selector parity across target-opponent and relational possessive sources; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3003 tests).
- 2026-02-17: Closed generic player-subject drift by extending deterministic effect-clause subject matching (draw/add_mana/scry/surveil/discard/mill/gain_life/lose_life/create_token/sacrifice and multi-create prefix) to accept `its owner` / `its controller` / `that <object>'s owner|controller`, aligning clause regexes with existing `parsePlayerSelector` support; added parser + executor regressions for `That creature's owner draws a card.` in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3005 tests).
- 2026-02-17: Closed cross-ability loose impulse upgrade drift for owner/controller third-person permission clauses by allowing global loose permission upgrades to apply to single-card `exile_top` seeds (amount = 1) when permission text is singular (`it` / `that card` / equivalent), enabling templates like `Target player exiles the top card ... Its owner may cast it this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3007 tests).
- 2026-02-17: Extended cross-ability loose impulse upgrade parity for fixed plural exile-top seeds by allowing global loose permission upgrades to apply to numeric `exile_top` amounts greater than 1 when permission text is plural-referential (`them` / `those cards` / exiled-cards variants), enabling templates like `Target player exiles the top two cards ... Its owner may cast them this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3009 tests).
- 2026-02-17: Closed loose-impulse phrasing parity gap for `spell(s) they exiled this way` by extending global loose permission object references and plural-upgrade gating to recognize those variants, enabling cross-ability owner/controller templates like `Target player exiles the top two cards ... Its owner may cast spells they exiled this way this turn.` to deterministically upgrade/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3011 tests).
- 2026-02-17: Closed remaining single-card loose-upgrade gating gap by allowing singular cross-ability permissions that reference `the card they exiled this way` / `the spell they exiled this way` to upgrade numeric-1 `exile_top` seeds (owner/controller third-person forms), enabling templates like `Target player exiles the top card ... Its owner may cast the spell they exiled this way this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3013 tests).
- 2026-02-17: Closed cross-ability loose duration-phrase drift by extending global loose permission parsing to accept `until the end of this turn` / `until the end of that turn` (in addition to end-of-turn short forms), enabling templates like `Target player exiles the top card ... Its owner may cast it until the end of this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3015 tests).
- 2026-02-17: Closed remaining cross-ability loose duration-phrase gap for `through end of turn` wording by extending global loose permission parsing to accept `through (the) end of (this|that) turn`, enabling templates like `Target player exiles the top card ... Its owner may cast it through end of this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3017 tests).
- 2026-02-17: Extended cross-ability loose impulse duration coverage to explicit next-turn windows by adding support for `during (your|their|the) next turn`, `until (your|their|the) next turn`, and `until/through end of (your|their|the) next turn` in global loose permission parsing; this enables owner/controller third-person templates like `Target player exiles the top card ... Its owner may cast it during their next turn.` / `... until the end of their next turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3021 tests).
- 2026-02-17: Extended cross-ability loose impulse duration coverage to next-upkeep and next-end-step windows by adding support for `until (the beginning of) (your|their|the) next upkeep` and `until (the beginning of) (your|their|the) next end step` in global loose permission parsing; this enables owner/controller third-person templates like `Target player exiles the top card ... Its owner may cast it until the beginning of their next upkeep.` / `... until your next end step.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3025 tests).
- 2026-02-17: Closed remaining cross-ability loose duration alias gap for `through` next windows by extending global loose permission parsing to accept `through (your|their|the) next turn`, `through (the beginning of) (your|their|the) next upkeep`, and `through (the beginning of) (your|their|the) next end step` (mapped to existing `until_next_*` durations), enabling templates like `Target player exiles the top card ... Its owner may cast it through their next turn.` / `... through your next upkeep.` / `... through your next end step.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3031 tests).
- 2026-02-17: Closed cross-ability loose duration gap for `until end of combat on (your|their|the) next turn` by extending global loose permission parsing to map that wording to `until_end_of_combat_on_next_turn`, enabling templates like `Target player exiles the top card ... Its owner may cast it until end of combat on their next turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3033 tests).
- 2026-02-17: Closed cross-ability loose leading-duration owner/controller gap by adding direct leading-duration global-loose permission parsing for explicit-subject forms (for example, `Until your next turn, its owner may cast it.` and `Until your next end step, its owner may cast it.`), ensuring deterministic upgrade of single-card `exile_top` seeds into `impulse_exile_top` without relying on clause rewrite ordering; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test -- --run`, 97 files / 3037 tests).
- 2026-02-17: Added regression parity for leading-duration owner **play** permission (`Until your next turn, its owner may play it.`) in cross-ability loose impulse upgrade coverage, including executor validation that a land card receives owner-scoped play permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`) and local `rules-engine` typecheck (`npm run typecheck`).
- 2026-02-17: Added regression parity for leading-duration controller **play** permission (`Until your next turn, its controller may play it.`) in cross-ability loose impulse upgrade coverage, including executor validation that a land card receives controller-scoped play permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added regression parity for leading-duration controller **cast** permission (`Until your next turn, its controller may cast it.`) in cross-ability loose impulse upgrade coverage, including executor validation that a nonland exiled card receives controller-scoped cast permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added regression parity for leading-duration next-end-step controller **cast** permission (`Until your next end step, its controller may cast it.`) in cross-ability loose impulse upgrade coverage, including executor validation that a nonland exiled card receives controller-scoped cast permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added regression parity for controller **play** permission with trailing `through your next end step` duration (`Its controller may play it through your next end step.`) in cross-ability loose impulse upgrade coverage, including executor validation that a land card receives controller-scoped play permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added regression parity for controller **cast** permission with trailing `through your next upkeep` duration (`Its controller may cast it through your next upkeep.`) in cross-ability loose impulse upgrade coverage, including executor validation that a nonland exiled card receives controller-scoped cast permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added regression parity for controller **cast** permission with trailing `during their next turn` duration (`Its controller may cast it during their next turn.`) in cross-ability loose impulse upgrade coverage, including executor validation that a nonland exiled card receives controller-scoped cast permission with the expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added batched controller **cast** duration parity regressions for trailing phrases `through their next turn`, `until the end of their next turn`, `until the beginning of their next upkeep`, and `until end of combat on their next turn` (target-player loose impulse templates), including executor validations that nonland exiled cards receive controller-scoped cast permissions with expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added further batched controller **cast** parity regressions for missing same-turn and trailing-next-end-step phrasings (`this turn`, `until the end of this turn`, `through end of this turn`, `until your next end step`, `through your next end step`) in target-player loose impulse templates, including executor validations that nonland exiled cards receive controller-scoped cast permissions with expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added batched owner **play** duration parity regressions for target-player loose impulse templates (`during their next turn`, `until the end of their next turn`, `through your next upkeep`, `through your next end step`), including executor validations that exiled lands receive owner-scoped play permissions with expected `playableUntilTurn`; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added batched controller **play** duration parity regressions for target-player loose impulse templates (`during their next turn`, `until the end of their next turn`, `through your next upkeep`), complementing existing controller play coverage (`until your next turn`, `through your next end step`); executor validations confirm exiled lands receive controller-scoped play permissions with expected `playableUntilTurn`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added a second controller **play** duration parity batch for target-player loose impulse templates (`through their next turn`, `until the beginning of their next upkeep`, `until your next end step`) to close remaining owner/controller `play` phrasing gaps; executor validations confirm exiled lands receive controller-scoped play permissions with expected `playableUntilTurn`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`).
- 2026-02-17: Added owner **play** duration parity regressions for target-player loose impulse templates (`through their next turn`, `until the beginning of their next upkeep`, `until your next end step`) and added leading `Until your next end step, ... may play it` coverage for both owner/controller subjects; confirmed parser/executor parity and duration-token conventions (`through ... next turn` => `until_next_turn`) with focused suites green (`651/651`) plus clean package typecheck.
- 2026-02-17: Extended loose impulse permission parsing to accept `can` as an alias for `may` (explicit-subject normalization + leading/trailing duration templates in the shared helper), and added target-player regressions for `Its owner can cast it this turn` and `Its controller can play it until your next end step` across parser/executor; focused suites green (`655/655`) and typecheck clean.
- 2026-02-17: Expanded `can` alias parity for leading-duration target-player templates by adding owner/controller regressions for `Until your next turn, ... can cast/play it` across parser/executor (owner can-cast, owner can-play, controller can-play, controller can-cast); focused suites remain green (`663/663`) and package typecheck remains clean.
- 2026-02-17: Added trailing-duration `can` alias parity regressions for controller cast-permission templates (`can cast it through your next upkeep`, `can cast it during their next turn`, `can cast it until the beginning of their next upkeep`) in target-player loose impulse parsing/execution; focused suites remain green (`669/669`) and typecheck remains clean.
- 2026-02-17: Added trailing-duration `can` alias parity regressions for owner/controller play-permission templates (`can play it during their next turn`, `can play it through your next upkeep`, `can play it until the beginning of their next upkeep`) in target-player loose impulse parsing/execution; focused suites remain green (`681/681`) and typecheck remains clean.
- 2026-02-17: Added end-step/next-turn `can` alias parity regressions for owner/controller cast-permission templates (`can cast it until your next end step`, `can cast it through your next end step`, `can cast it through their next turn`, `can cast it until the end of their next turn`) in target-player loose impulse parsing/execution; focused suites remain green (`697/697`) and typecheck remains clean.
- 2026-02-17: Added end-step/next-turn `can` alias parity regressions for owner/controller play-permission templates (`can play it until your next end step`, `can play it through your next end step`, `can play it through their next turn`, `can play it until the end of their next turn`) in target-player loose impulse parsing/execution; focused suites remain green (`711/711`) and typecheck remains clean.
- 2026-02-17: Added first-person loose impulse `can` alias regressions for `You can play it until your next end step`, `You can play it through your next end step`, and `You can cast it this turn` across parser/executor (anchored to existing `You may ...` templates); focused suites remain green (`717/717`) and typecheck remains clean.
- 2026-02-17: Added first-person trailing next-turn `can` alias parity regressions for `You can play that card until end of your next turn` and `You can play that card until end of the next turn` across parser/executor (anchored next to existing `You may ... until end of ... next turn` coverage); focused suites remain green (`721/721`) and typecheck remains clean.
- 2026-02-17: Added corpus-grounded first-person `may cast` next-turn regression parity for `Until the end of your next turn, you may cast that card.` (seen in AtomicCards-style templates such as Hurl Through Hell / Retrieve Prey), with matching parser/executor coverage; focused suites remain green (`723/723`) and typecheck remains clean.
- 2026-02-17: Added corpus-grounded leading next-turn pronoun-parity regressions for `Until the end of your next turn, you may play them.` (seen in AtomicCards templates such as Season of the Bold mode text), with parser/executor coverage for top-two exile-top impulse behavior; focused suites remain green (`725/725`) and typecheck remains clean.
- 2026-02-17: Added executor parity regression for the corpus-grounded Lidless Gaze-style next-turn mana rider template (`Exile the top card of each player's library. Until the end of your next turn, you may play those cards, and mana of any type can be spent to cast those spells.`), aligning executor coverage with existing parser support; focused suites remain green (`726/726`) and typecheck remains clean.
- 2026-02-17: Added executor parity regression for the corpus-grounded target-opponent choose-one mana-rider template (`Exile the top three cards of target opponent's library. Choose one of them. Until the end of your next turn, you may play that card, and you may spend mana as though it were mana of any color to cast it.`), matching existing parser coverage for the AtomicCards `You Find a Cursed Idol`-style wording; focused suites remain green (`727/727`) and typecheck remains clean.
- 2026-02-17: Added parser+executor parity regressions for the exact corpus-grounded `Hurl Through Hell` next-turn cast + mana-rider wording (`Exile target creature. Until the end of your next turn, you may cast that card and you may spend mana as though it were mana of any color to cast that spell.`), anchoring `cast that spell` rider handling to real-card template usage; focused suites remain green (`729/729`) and typecheck remains clean.
- 2026-02-17: Added persistent-duration cast+rider parity regressions for corpus-grounded `for as long as it remains exiled` templates by covering `... you may cast that card for as long as it remains exiled, and mana of any type can be spent to cast that spell` in look-then-exile target-player flows (aligned with real card families such as Gonti/Hostage Taker/The Magic Bandit); focused parser+executor suites remain green (`731/731`) and typecheck remains clean.
- 2026-02-17: Extended corpus-grounded persistent-duration mana-rider parity with explicit `that player's library` play-template coverage (`Look at the top card of that player's library, then exile it face down. You may play that card for as long as it remains exiled, and mana of any type can be spent to cast that spell.`) across parser + executor, including context-bound executor validation via `selectorContext.targetPlayerId`; focused suites remain green (`733/733`) and typecheck remains clean.
- 2026-02-17: Added parser+executor parity regressions for the exact corpus-grounded `Thought-String Analyst` singular template (`At the beginning of your upkeep, exile the top card of target opponent's library face down. You lose life equal to its mana value. You may look at and play that card for as long as it remains exiled, and mana of any type can be spent to cast that spell.`), validating persistent-duration look+play+rider handling with intervening deterministic clause; focused suites remain green (`735/735`) and typecheck remains clean.
- 2026-02-17: Added parser+executor parity regressions for the exact corpus-grounded `Gonti, Night Minister` look-then-exile sentence (`... look at the top card of that player's library, then exile it face down. You may play that card for as long as it remains exiled, and mana of any type can be spent to cast that spell.`), including executor context-bound target-player resolution; focused suites remain green (`737/737`) and typecheck remains clean.
- 2026-02-17: Added executor parity regression for the corpus-grounded plural face-down look+exile mana-rider template (`Look at the top two cards of target opponent's library and exile those cards face down. You may play those cards for as long as they remain exiled, and mana of any type can be spent to cast them.`), aligning executor coverage with existing parser support; focused parser+executor suites remain green (`738/738`) and typecheck remains clean.
- 2026-02-17: Added corpus-grounded executor parity regression for the exact `Dead Man's Chest`-style unknown-amount template (`... exile cards equal to its power from the top of its owner's library ... cast spells from among those cards for as long as they remain exiled, and mana of any type can be spent to cast them.`), locking safe-skip behavior when amount is non-deterministic; focused parser+executor suites remain green (`739/739`) and typecheck remains clean.
- 2026-02-17: Added corpus-grounded executor parity regression for exact `Transforming Flourish` wording (`... its controller exiles cards from the top of their library until they exile a nonland card, then they may cast that card without paying its mana cost.`), locking deterministic safe-skip behavior for non-deterministic exile-until amounts while preserving target-player selector-context binding; focused parser+executor suites remain green (`740/740`) and typecheck remains clean.
- 2026-02-17: Added corpus-grounded executor parity regression for exact `Possibility Storm` wording (`... exiles cards from the top of their library until they exile a card that shares a card type with it. That player may cast that card without paying its mana cost ...`), locking deterministic safe-skip behavior for non-deterministic exile-until amounts with target-player selector-context binding; focused parser+executor suites remain green (`741/741`) and typecheck remains clean.
- 2026-02-17: Added corpus-grounded executor parity regression for exact `Chaos Wand` activated wording (`Target opponent exiles cards from the top of their library until they exile an instant or sorcery card. You may cast that card without paying its mana cost ...`), locking deterministic safe-skip behavior for non-deterministic exile-until amounts with `target_opponent` selector-context binding; focused parser+executor suites remain green (`742/742`) and typecheck remains clean.
- 2026-02-17: Implemented deterministic executor loop support for inferable unknown `until ...` exile amounts in `impulse_exile_top`/`exile_top` (currently supports `until ... nonland card`, `until ... instant or sorcery card`, `until ... legendary card`, and `until ... total mana value N or greater`), with regression updates/additions proving applied behavior for exact corpus templates `Transforming Flourish`, `Chaos Wand`, and `Dream Harvest` while preserving safe-skip for unsupported `until` criteria (for example, `shares a card type with it`); focused parser+executor suites remain green (`743/743`) and typecheck remains clean.
- 2026-02-17: Added executor parity regression for exact `Wand of Wonder` wording (`Each opponent exiles cards from the top of their library until they exile an instant or sorcery card ...`) to lock multi-opponent loop behavior under the new deterministic unknown-`until` amount support; focused parser+executor suites remain green (`744/744`) and typecheck remains clean.
- 2026-02-17: Extended deterministic unknown-`until` loop support to `until ... exile a card that shares a card type with it` by threading `spellType` through stack trigger metadata → Oracle IR execution hints (`referenceSpellTypes`) and resolving per-player loop counts in executor; added regressions for both safe-skip (missing reference spell type) and applied behavior (reference type present) on exact `Possibility Storm` wording, plus context-normalization coverage in `buildOracleIRExecutionContext`; focused parser+executor suites remain green (`746/746`) and typecheck remains clean.
- 2026-02-17: Added executor parity regression for exact `Bismuth Mindrender` wording (`that player exiles cards ... until they exile a nonland card`), validating target-player loop execution under deterministic unknown-`until` support and preserving cast-permission flow; focused parser+executor suites remain green (`747/747`) and typecheck remains clean.
- 2026-02-17: Added deterministic support for Chaos-Wand/Possibility-Storm style bottom-of-library cleanup after impulse exiling (`Then put the exiled cards that weren't cast this way on the bottom ...` / `Then put all cards exiled ... on the bottom ...`), including parser-split fallback detection by impulse-step shape when trailing rider text is in a separate sentence; updated regressions now verify both hit and no-hit Chaos Wand outcomes (if no instant/sorcery is found, all revealed/exiled cards are returned to library bottom) and Possibility Storm applied path cleanup; focused parser+executor suites remain green (`748/748`) and typecheck remains clean.
- 2026-02-17: Added Trepanation-Blade-style reveal-until-land support by parsing `... reveals cards from the top of their library until they reveal a land card` into deterministic `mill` with unknown-until amount and implementing corresponding executor loop resolution for `until ... reveal a land card`; added parser and executor regressions proving target-opponent context binding and correct graveyard movement of all revealed cards; focused parser+executor suites remain green (`750/750`) and typecheck remains clean.
- 2026-02-17: Completed Trepanation full-effect deterministic path by introducing/using `modify_pt_per_revealed` execution (`The creature gets +1/+0 ... for each card revealed this way`) and adding conservative cross-ParsedAbility merge for parser-split trailing static `revealed this way` clauses into the preceding triggered reveal-until ability; added parser+executor regressions for pump-step parsing/application (including equipped-creature target resolution via source attachment), validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `754/754`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Introduced composable temporary P/T Oracle IR execution via new generic `modify_pt` step (target + base `power/toughness` delta + `duration` + optional `scaler`) and migrated Trepanation parsing to use `scaler: per_revealed_this_way` while adding direct Giant-Growth-style parsing/execution (`Target creature gets +3/+3 until end of turn`); executor now resolves deterministic creature targets for `target creature` and applies reusable end-of-turn P/T modifiers through shared logic, with focused parser+executor suites green (`756/756`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Generalized composable P/T clause parsing to explicitly treat trailing `for each ...` as scaler metadata on `modify_pt` (known scaler `per_revealed_this_way` plus captured `unknown` scaler raw text for forward compatibility), and updated executor to safely skip unsupported unknown scalers while still applying deterministic known scalers; added parser+executor regressions for unknown-scaler capture/skip behavior, with focused suites green (`758/758`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Hardened intervening-if handling across trigger pipelines by normalizing clause resolution from `interveningIfClause` with a safe fallback to `condition` when `hasInterveningIf` is set, applying that logic consistently at trigger-time checks (`checkTrigger` / `createTriggerInstance`) and auto-resolution checks (`processEventAndExecuteTriggeredOracle`), and adding stack-resolution safety in `RulesEngineAdapter` to skip execution when intervening-if is flagged but clause data is missing; added regressions in `triggerParsing.test.ts`, `triggersHandler.test.ts`, and `RulesEngineAdapter.test.ts`, validated with focused suites (`124/124`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Extended clause-role parsing for composable `modify_pt` steps to capture condition metadata (`if ...`, `as long as ...`, `where ...`) alongside existing duration/scaler parts, while preserving deterministic safety by skipping unsupported condition-backed modifiers in executor until condition evaluation is wired; added parser+executor regressions for condition capture and safe-skip behavior, validated with focused suites (`762/762`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Enabled first deterministic execution subset for clause-role `modify_pt` conditions by evaluating `if/as long as you control ...` (including `N or more` counts for creature/artifact/enchantment/land/planeswalker/permanent/nonland permanent) against current battlefield controller state, while keeping `where ...` conditions as explicit safe-skip; added executor regressions for true-condition apply path and where-clause skip path, with focused parser+executor suites green (`764/764`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Added deterministic `where` evaluation support for composable `modify_pt` by resolving `where X is the number of <class> you control` (same supported class set as control-condition checks) and applying parsed `+X/-X` P/T components via signed X coefficients (`powerUsesX` / `toughnessUsesX`), while preserving safe-skip for unsupported `where` expressions; added parser+executor regressions for X-component parsing, supported apply paths, and unsupported-where skip behavior, with focused suites green (`767/767`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Expanded deterministic `where` evaluator coverage for composable `modify_pt` to include additional real-template forms: `X is the number of <classes> your opponents control`, `X is the number of opponents you have`, `X is the number of cards in your graveyard/hand/library/exile`, `X is half your life total (rounded up/down)`, `X is that creature's power/toughness`, `X is the number of counters on this/that creature`, `X is the greatest mana value among permanents you control`, and `X is the number of cards exiled with this permanent`; retained explicit safe-skip for still-unsupported expressions (for example, `cards named ...` qualifiers). Added/updated focused regressions in `oracleIRExecutor.test.ts`; final focused parser+executor suites green (`773/773`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Further expanded deterministic `where` support for composable `modify_pt` with arithmetic wrappers and broader count sources: `X is one/N plus ...`, `X is twice ...`, `X is half the ... (rounded up/down)`, typed zone-card counts such as `X is the number of creature cards in your graveyard`, and global battlefield counts such as `X is the number of artifacts on the battlefield`; also added pronoun-style aliases (`its power/toughness`, `this creature's power/toughness`) for target-bound lookups. Added focused executor regressions for these forms; parser+executor focused suites green (`777/777`) and `npm run typecheck` clean in `rules-engine`.
- 2026-02-17: Added deterministic support for `Wand of Wonder` shuffle-rest rider (`... then shuffles the rest into their library`) by returning non-hit exiled cards to library after `until instant or sorcery` loop resolution; includes parser-split fallback detection by impulse-step shape (`each_opponent` + during-resolution cast-permission + instant/sorcery until-criterion), with updated regression proving only the hit card remains exiled; focused parser+executor suites remain green (`750/750`) and typecheck remains clean.
- 2026-02-17: Performed targeted post-Chaos audit for recently implemented corpus templates; identified and documented remaining partial fidelity scope: Trepanation Blade's power pump sentence (`+1/+0 for each card revealed this way`) is still not executed as a deterministic combat stat modifier, and randomization semantics (`random order`/`shuffles`) remain deterministic approximations in current automation paths.
- 2026-02-17: Added explicit parser+executor parity regressions for exact `Undercity Informer` activated Oracle wording (`Target player reveals cards from the top of their library until they reveal a land card, then puts those cards into their graveyard.`), confirming deterministic target-player reveal-until-land milling works under activation context; focused parser+executor suites remain green (`752/752`) and typecheck remains clean.
- 2026-02-17: Added no-hit edge-case regression coverage for recently implemented cleanup templates to guard against partial implementations: `Possibility Storm` now explicitly verifies that when no shared card type is found all revealed/exiled cards are returned to library bottom, and `Wand of Wonder` now explicitly verifies per-opponent mixed outcomes (no-hit opponent returns all revealed cards; hit opponent keeps only the hit instant/sorcery exiled); focused parser+executor suites remain green (`754/754`) and typecheck remains clean.
- 2026-02-17: Closed a parser normalization edge case where passing card name `Test` could corrupt unrelated words containing that substring (for example, `greatest` -> `greathis permanent`) by switching card-name replacement to escaped, boundary-aware matching in `parseOracleText`; added regression coverage in `oracleTextParser.test.ts` and validated with focused suites (`npx vitest run test/oracleTextParser.test.ts test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `852/852`) plus clean package typecheck.
- 2026-02-17: Expanded deterministic `modify_pt` `where` support for context-bound player zones and source-referential stat phrases by adding `that player's` / `their` zone card-count evaluation (`graveyard/hand/library/exile`, typed and untyped) plus generic `this/that/its <object>'s power|toughness|mana value` evaluation with deterministic source/target binding; added executor regressions in `oracleIRExecutor.test.ts` and validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `784/784`) plus clean package typecheck.
- 2026-02-17: Added deterministic `where` support for Consuming-Aberration-style graveyard sizing (`X is the number of cards in your opponents' graveyards`, including equivalent all-opponents phrasing), counting only non-controller graveyards; added focused executor regression in `oracleIRExecutor.test.ts` and validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `785/785`) plus clean package typecheck.
- 2026-02-17: Expanded deterministic `where` phrase coverage for card-count and battlefield-relative templates by adding support for `X is the number of cards in all players' hands`, `X is the number of cards in your opponents' hands`, and `X is the number of other creatures on (the) battlefield` (source-bound), with a control-flow fix to avoid premature fallback nulls from the generic battlefield matcher; added focused executor regressions and validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `788/788`) plus clean package typecheck.
- 2026-02-17: Added deterministic `where` support for high-frequency Domain/tap templates: `X is the number of basic land types among lands you control` and `X is the number of tapped creatures you control` (plus `untapped` variant), and hardened matcher flow by preventing premature null returns in generic `you control`/`your opponents control` where branches so more-specific patterns can resolve; added focused executor regressions and validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `790/790`) plus clean package typecheck.
- 2026-02-17: Added deterministic `where` support for devotion templates (`X is your devotion to white|blue|black|red|green`) by counting color-matching mana symbols in mana costs of permanents you control (including hybrid/phyrexian-style symbols via symbol containment), and added focused executor regressions for blue/black devotion while keeping deterministic single-target fixtures; validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `792/792`) plus clean package typecheck.
- 2026-02-17: Expanded deterministic opponent-scoped `where` coverage in `evaluateModifyPtWhereX` for `X is the greatest mana value among permanents your opponents control` (plus parity logic for `greatest power|toughness among creatures your opponents control`), added focused executor regression in `oracleIRExecutor.test.ts`, and validated with focused executor suite (`npx vitest run test/oracleIRExecutor.test.ts`, `447/447`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-17: Added deterministic single-target resolution for controller-qualified selectors in `resolveSingleCreatureTargetId` (`target creature you control`, `target creature your opponents control`, `target creature an opponent controls`) so `modify_pt` effects no longer skip when battlefield has multiple creatures; added focused executor regression for `X is the greatest toughness among creatures your opponents control` with `target creature you control`, validated with focused executor suite (`npx vitest run test/oracleIRExecutor.test.ts`) and clean `rules-engine` typecheck.
- 2026-02-17: Fixed `modify_pt` parsing drift where controller-qualified targets were dropped by broadening the parser match from literal `target creature` to include `target creature you control` / `your opponents control` / `an opponent controls`, preserving raw target text for deterministic executor filtering; added parser+executor regressions for `target creature you control` with opponent-scoped greatest-toughness `where` evaluation, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `796/796`) and clean `rules-engine` typecheck.
- 2026-02-17: Added sibling parser+executor coverage for opponent-qualified single-target selectors in `modify_pt` (`target creature your opponents control` and `target creature an opponent controls`) with deterministic fixtures that validate controller-filtered target resolution and `where X is the greatest power among creatures you control`; focused suites remain green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `800/800`) and `rules-engine` typecheck remains clean.
- 2026-02-17: Added explicit executor parity regression for `where X is the greatest power among creatures your opponents control`, using deterministic opponent-qualified targeting (`target creature your opponents control`) to lock both power and toughness branches for opponent-scoped `greatest` evaluation; focused suites remain green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `801/801`) and `rules-engine` typecheck remains clean.
- 2026-02-17: Added deterministic `where` support for `X is the greatest power|toughness among other creatures you control` with source/target-aware exclusion, then fixed exclusion precedence to prefer `targetCreatureId` over `sourceId` so equipped-creature/targeted modify paths correctly exclude the modified creature itself; added focused regression in `oracleIRExecutor.test.ts` and validated with focused suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `802/802`) plus clean `rules-engine` typecheck.
- 2026-02-17: Added deterministic opponent-side parity for `where X is the greatest power|toughness among other creatures your opponents control` with the same source/target-aware exclusion semantics; added focused executor regression using deterministic equipped-target binding (`the creature`) to avoid multiplayer target ambiguity while validating exclusion of the modified opponent creature, with focused suites green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `803/803`) and `rules-engine` typecheck clean.
- 2026-02-17: Added deterministic `where` support for `X is the greatest mana value among other permanents you control` and opponent-side parity `... your opponents control`, with focused executor regressions using deterministic equipped-target binding (`the creature`) and fixture tuning to preserve stable target-aware exclusion behavior; focused parser+executor suites are green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `805/805`) and `rules-engine` typecheck remains clean.
- 2026-02-17: Added deterministic global battlefield parity for mana-value `where` templates: `X is the greatest mana value among permanents on the battlefield` and `... among other permanents on the battlefield`, including source/target-aware exclusion for `other`; added focused executor regressions with deterministic equipped-target binding and validated with focused parser+executor suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `807/807`) plus clean `rules-engine` typecheck.
- 2026-02-17: Added deterministic global battlefield parity for creature stat `where` templates: `X is the greatest power|toughness among creatures on the battlefield` and `... among other creatures on the battlefield`, including source/target-aware exclusion for `other`; added focused executor regressions with deterministic equipped-target binding and validated with focused parser+executor suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `809/809`) plus clean `rules-engine` typecheck.
- 2026-02-17: Added deterministic subtype-scoped `where` support for corpus-backed `non-Human` templates in greatest-stat evaluation: `X is the greatest power|toughness among non-Human creatures you control` and opponent-side parity `... your opponents control`; added focused executor regressions (deterministic equipped-target binding where needed) and validated with focused parser+executor suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `811/811`) plus clean `rules-engine` typecheck.
- 2026-02-17: Hardened subtype-scoped greatest-stat matching to accept `nonhuman`/`non-human`/`non human` spellings and added battlefield parity for non-subtype variants (`X is the greatest power|toughness among (other )?non-Human creatures on the battlefield`), with focused executor regressions for nonhuman spelling + battlefield scope; focused parser+executor suites remain green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `813/813`) and `rules-engine` typecheck remains clean.
- 2026-02-17: Added `other` parity for subtype-scoped non-Human greatest-stat controller filters by extending control/opponent forms to `X is the greatest power|toughness among other non-Human creatures you control` and `... your opponents control`, with target/source-aware exclusion semantics; added focused deterministic executor regressions and validated with focused parser+executor suites (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `815/815`) plus clean `rules-engine` typecheck.
- 2026-02-17: Locked additional negation-scope greatest-stat coverage with focused regressions for `nonartifact` and `nonland` creature filters (`X is the greatest power among nonartifact creatures you control`, `X is the greatest toughness among other nonland creatures on the battlefield`), confirming current generic non-qualifier matcher behavior remains deterministic; focused parser+executor suites remain green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `817/817`) and `rules-engine` typecheck remains clean.
- 2026-02-17: Added deterministic non-qualifier parity for mana-value `where` templates across control/opponent/battlefield scopes: `X is the greatest mana value among (other )?nonartifact permanents ...` and `... nonland permanents ...` (including `you control`, `your opponents control`, and `on the battlefield`), with focused executor regressions using deterministic equipped-target binding for `other` exclusions; focused parser+executor suites remain green (`npx vitest run test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`, `820/820`) and `rules-engine` typecheck remains clean.
- 2026-02-17: Added deterministic negated-count `where` support for `X is the number of (other )?non... creatures|permanents` across controller/opponent/battlefield scopes (`you control`, `your opponents control`, `on the battlefield`) with target/source-aware `other` exclusion semantics; added focused executor regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `474/474`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Expanded negated-count regression parity to cover remaining scope variants and `other` exclusions (`other nonland creatures on the battlefield`, `other nonartifact permanents you control`, `other nonartifact permanents your opponents control`) in `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `477/477`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added negated-count spelling-variant parity regressions for `nonhuman`/`non-human`/`non human` style where phrases in creature and permanent count templates (including battlefield and opponent scopes) within `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `480/480`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic `least/lowest` where evaluation support in `evaluateModifyPtWhereX` for `X is the least power|toughness among creatures ...` and `X is the lowest mana value among permanents ...` across controller/opponent/battlefield scopes, with focused regressions in `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `486/486`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Extended `least/lowest` parity with `other` and `non...` variants in `evaluateModifyPtWhereX` for both creature-stat and permanent-mana-value templates across controller/opponent/battlefield scopes (including `least ... among other creatures ...`, `least ... among (other )?non... creatures ...`, and `lowest mana value among (other )?non... permanents ...`); added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `493/493`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Completed `least/lowest` phrasing+arithmetic parity by adding `lowest` synonym support for least-stat creature templates and validating arithmetic wrappers over least/lowest where forms (`one plus`, `twice`, and `half the ... rounded up/down`); fixed half-wrapper inner resolution in `evaluateModifyPtWhereX` by retrying with a leading `the` when needed, and added focused regressions in `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `498/498`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic `highest` synonym parity for existing `greatest` where templates in `evaluateModifyPtWhereX` across creature stats and mana value scopes (including `other` and `non...` variants), and added focused regressions in `oracleIRExecutor.test.ts` for direct stat/mana usage plus arithmetic wrapper composition (`one plus the highest ...`); validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `501/501`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic `smallest` synonym parity for existing `least/lowest` where templates in `evaluateModifyPtWhereX` across creature stats and mana value scopes (including `other` and `non...` variants), and added focused regressions in `oracleIRExecutor.test.ts` for direct stat, arithmetic composition (`twice the smallest ...`), and scoped non-qualifier forms; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `504/504`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic `converted mana cost` synonym parity for existing mana-extrema where templates in `evaluateModifyPtWhereX` (for `greatest/highest` and `least/lowest/smallest` across controller/opponent/battlefield scopes, including `other` and `non...` variants), and added focused regressions in `oracleIRExecutor.test.ts` for direct, arithmetic (`one plus the highest converted mana cost ...`), and non-qualifier scoped forms; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `507/507`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added opponent-scope alias parity for core deterministic where extrema templates in `evaluateModifyPtWhereX` by accepting `you don't control` and `an opponent controls` alongside `your opponents control` for creature-stat and mana-extrema forms (greatest/highest + least/lowest/smallest); added focused regressions in `oracleIRExecutor.test.ts` including arithmetic composition (`one plus the highest converted mana cost among permanents you don't control`) and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `510/510`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Extended opponent-scope alias parity to also accept `you do not control` in the same core deterministic where extrema templates (creature-stat and mana-extrema forms), with focused regressions in `oracleIRExecutor.test.ts` for `highest power among creatures you do not control` and `smallest converted mana cost among permanents you do not control`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `512/512`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Extended opponent-scope alias parity into remaining `other`/`non...` extrema opponent branches in `evaluateModifyPtWhereX` (for greatest/highest and least/lowest/smallest creature-stat + mana-extrema forms), accepting `an opponent controls`, `you don't control`, and `you do not control` alongside `your opponents control`; added focused regressions in `oracleIRExecutor.test.ts` for `highest power among other creatures you do not control` and `smallest converted mana cost among other nonartifact permanents an opponent controls`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `514/514`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Extended the same opponent-scope alias set into negated-count where templates by updating `X is the number of (other )?non... creatures/permanents ...` to accept `an opponent controls`, `you don't control`, and `you do not control` alongside `your opponents control`; added focused regressions in `oracleIRExecutor.test.ts` for `number of other nonhuman creatures an opponent controls` and `number of other nonartifact permanents you do not control`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `516/516`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic support for attacking-count where templates by evaluating `X is the number of attacking creatures` (plus `... on the battlefield`) and controller-scoped variants (`attacking creatures you control`, `attacking creatures an opponent controls` and existing opponent aliases) via battlefield `attacking` state; added focused regressions in `oracleIRExecutor.test.ts` for global and opponent-scoped attacking-count forms and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `518/518`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Expanded deterministic `where` class-count coverage for subtype/plural templates by adding safe singular fallback normalization in `normalizeControlledClassKey` (enabling corpus-backed phrases such as `X is the number of shrines you control`, `... mountains you control`, and `... elves on the battlefield` to resolve through existing count branches); added focused regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `521/521`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic Party where support in `evaluateModifyPtWhereX` for `X is the number of creatures in your party` (counts unique roles among creatures you control: Cleric, Rogue, Warrior, Wizard, up to 4), with focused regression coverage in `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `522/522`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic specific-counter where support in `evaluateModifyPtWhereX` for `X is the number of <counter> counters on this|that|it ...` (including object-aware source binding for noncreature references like `this enchantment`), enabling corpus-backed templates such as `+1/+1 counters on this creature` and `verse counters on this enchantment`; added focused regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `524/524`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Expanded deterministic attacking-count where support to include `other` exclusion semantics for templates like `X is the number of other attacking creatures` (including opponent-scoped aliases such as `... an opponent controls`) by excluding the modified/source creature from attacking-count pools; added focused regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `526/526`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic high-frequency where support for `X is its mana value` and `X is the number of colors among permanents you control` (including color extraction from explicit color arrays, color identity, and mana-cost symbols), with focused regressions in `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `528/528`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Expanded deterministic qualified-count where support with corpus-backed templates `X is the number of other creatures you control`, `... legendary creatures you control`, `... creatures you control with defender`, and `... differently named lands you control`; added focused regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `532/532`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic stack/context-bound mana-value where support for high-frequency `X is that spell's mana value` by resolving `sourceId` across battlefield/stack/zones via shared object lookup; added focused regression in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `533/533`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Expanded context-bound mana-value where support to adjacent high-frequency card-reference variants `X is that card's mana value` and `X is the mana value of the exiled card` (plus equivalent exiled/revealed/discarded-card phrasing), reusing shared `sourceId` object lookup across battlefield/stack/zones with conservative safe-skip when unresolved; added focused regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `535/535`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic graveyard-aggregation where support for `X is the number of card types among cards in your graveyard` and `X is the number of cards in all graveyards with the same name as that spell`, using type-line aggregation and context-bound source-name matching across all players' graveyards; added focused regressions in `oracleIRExecutor.test.ts` and validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `537/537`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic commander-scope mana-extrema where support for `X is the greatest mana value of a commander you own on the battlefield or in the command zone` by evaluating commander-marked objects from battlefield and command-zone payloads (with conservative owner/flag checks), with focused regression in `oracleIRExecutor.test.ts`; validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `538/538`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added high-frequency lock coverage for existing deterministic class-count templates (`instant and sorcery cards in your graveyard`, `permanent cards in your graveyard`, `zombies you control`) and fixed a root-cause plural normalization bug (`zombies` singularized incorrectly to `zomby`) in `normalizeControlledClassKey`; focused suite updated and validated (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `541/541`) with clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic high-frequency where support for `X is the amount of life you gained (this turn)` and `X is the sacrificed creature's power|toughness|mana value` by reading controller-scoped life-gain turn stats and context-bound sacrificed-creature attributes from shared object lookup; added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `544/544`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic high-frequency where support for turn-history count phrases `X is the number of creatures that died this turn` and `X is the number of permanents you've sacrificed this turn` by reading `creaturesDiedThisTurnByController` (summed total) and controller-scoped `permanentsSacrificedThisTurn`; added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `546/546`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic high-frequency mana-spend where support for `X is the number of colors of mana spent to cast this/that spell` and `X is the amount of mana spent to cast this/that spell` by resolving source-bound spend metadata (`manaColorsSpent`/`manaSpentColors`, spend records, and total fields) with conservative safe-skip when unavailable; added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `548/548`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic high-frequency where support for `X is the total power of creatures you control` and `X is the number of creatures you control with power N or greater` by evaluating controller-scoped battlefield creature stats directly; added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `550/550`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic where support for life-loss phrasing `X is the amount of life you lost this turn` (including `you've` variant) by reading controller-scoped life-loss turn stats (`lifeLostThisTurn`/`lifeLost`/`turnStats.lifeLost`) in `evaluateModifyPtWhereX`; added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `552/552`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
- 2026-02-18: Added deterministic where support for discard-history phrasing `X is the number of cards you've/you have discarded this turn` by reading controller-scoped discard turn stats (`cardsDiscardedThisTurn`/`cardsDiscarded`/`turnStats.cardsDiscarded`) in `evaluateModifyPtWhereX`; added focused regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`npm run test --workspace=rules-engine -- test/oracleIRExecutor.test.ts`, `554/554`) plus clean `rules-engine` typecheck (`npm run typecheck --workspace=rules-engine`).
