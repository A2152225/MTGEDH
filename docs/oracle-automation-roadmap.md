# Oracle Automation Roadmap

Last updated: 2026-02-17
Owner: Copilot + project maintainers
Scope: rules-engine Oracle text intent parsing/execution reliability and coverage

## Objective

Increase deterministic Oracle-text automation so the engine executes more card intent correctly with minimal skips, while refusing unsafe/ambiguous actions.

## Application-Level Alignment

This roadmap supports the broader MTGEDH goal:
- Multiplayer Commander gameplay with strong rules fidelity.
- Real-time reliability for up to 8 players.
- Less manual bookkeeping via safe automation.

## Milestone Model (3 Layers)

### Layer 1 — Reliability Foundation (short-term)
Goal: Make current automation paths robust against malformed context and multiplayer ambiguity.

Milestones:
- M1.1 Canonical context normalization across trigger/adapter/executor.
- M1.2 Deterministic selector binding precedence and sanitization.
- M1.3 Invalid-context safety (never over-resolve targets).
- M1.4 Regression guardrails for precedence/sanitization matrices.

Exit criteria:
- Shared normalization path used by major trigger/stack execution flows.
- Ambiguous target selectors skip safely rather than mis-target.
- Focused test suites + typecheck consistently green.

### Layer 2 — Coverage Expansion (mid-term)
Goal: Increase the percentage of Oracle templates that execute end-to-end without manual intervention.

Milestones:
- M2.1 Expand deterministic selector support (player/object/group patterns).
- M2.2 Broaden trigger/event hint derivation from runtime payloads.
- M2.3 Add parser coverage for frequent real-card phrasing variants.
- M2.4 Add integration tests for event->stack->resolution chains.

Exit criteria:
- More common Commander card templates execute automatically.
- New parser/executor additions ship with regression tests.
- No increase in false-positive executions.

### Layer 3 — Interaction Fidelity (long-term)
Goal: Improve correctness for complex interactions while preserving deterministic behavior.

Milestones:
- M3.1 Deepen intervening-if and condition-gated resolution handling.
- M3.2 Improve APNAP-sensitive and multiplayer edge sequencing.
- M3.3 Strengthen stack metadata continuity from source event to final resolution.
- M3.4 Add confidence reporting/telemetry for skipped vs applied effect paths.

Exit criteria:
- Complex multiplayer interactions are handled with predictable outcomes.
- Skip reasons are explicit and traceable.
- Fidelity improvements do not regress baseline reliability.

## Current Status Snapshot

Status key: `done`, `in-progress`, `not-started`, `blocked`

| ID | Milestone | Status | Notes |
|---|---|---|---|
| M1.1 | Canonical normalization pipeline | done | Shared trigger/stack context builders integrated. |
| M1.2 | Deterministic selector precedence | done | Explicit > inferred singleton > base fallback enforced in tests. |
| M1.3 | Invalid-context safety | done | Controller/opponent sanitization and malformed-ID hardening added. |
| M1.4 | Reliability regression guardrails | done | Matrix tests + focused adapter/trigger/executor regressions in place. |
| M2.1 | Deterministic selector expansion | done | Selector-context hardening completed for singleton/relational multiplayer cases across parser/executor/adapter. |
| M2.2 | Runtime hint derivation breadth | done | Trigger/event hint normalization unified across cast/activate/resolve paths, including legacy target shaping. |
| M2.3 | Oracle phrasing coverage | done | Added deterministic support for `its controller` selector phrasing (including possessive library forms) across parser/executor paths with regressions. |
| M2.4 | End-to-end chain integration tests | done | Added cast/activate and legacy stack event->stack->resolution regressions for target and relational contexts. |
| M3.1 | Intervening-if fidelity expansion | done | Opponent-control condition classes broadened with threshold handling across creatures/artifacts/enchantments/lands/planeswalkers/permanents, with direct tests. |
| M3.2 | APNAP/multiplayer edge sequencing | done | APNAP ordering now covers turn-order wrap-around and active-missing fallback behaviors, validated by regression matrix tests. |
| M3.3 | Stack metadata continuity | done | Canonical metadata shaping now covers primary and legacy stack resolution paths. |
| M3.4 | Skip/apply confidence telemetry | done | Trigger flow now exposes counters and emits structured telemetry summary logs for executions/applied/skipped paths. |

## Working Backlog (Next Up)

No uncovered milestone-critical items remain from the current roadmap pass.

Follow-up (non-blocking hardening):
1. Continue opportunistic parser template expansion for newly observed corpus phrasing variants.
2. Consider legacy `AutomationService` stack item modernization to align with canonical trigger metadata patterns used in active adapter/trigger pipelines.

## Update Protocol

When a milestone changes state:
1. Update `Last updated` date.
2. Change milestone status in **Current Status Snapshot**.
3. Add one line in **Milestone Change Log** with evidence (tests or typecheck command).

## Milestone Change Log

- 2026-02-16: Initialized roadmap with 3-layer model and baseline status mapped to current implementation progress.
- 2026-02-16: Hardened direct-context selector normalization for player + battlefield controller filters (including invalid/whitespace controller handling) and added regressions; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Normalized move-zone controller usage in `applyOracleIRStepsToGameState` (including each-opponent zone traversals and your-zone transfers) and added whitespace-controller regressions; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened each-opponent move-zone execution to require a valid controller in current state (prevents malformed-controller over-resolution to all players) and added regression coverage; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened resolution event-data fallback to avoid fabricating `lifeTotal=0` when controller lookup fails (prevents false life-threshold condition matches), with regression coverage in `triggerParsing.test.ts`; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened resolution turn-state derivation to require a valid controller before computing `isYourTurn`/`isOpponentsTurn` (prevents false turn-condition matches under malformed controller context) while preserving explicit base fallback flags; added regressions in `triggerParsing.test.ts` and validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Tightened trigger target inference so generic `targetId`/`targetIds` cannot pollute `targetPlayerId`/`targetOpponentId` bindings (object/permanent IDs no longer misclassified as player targets), with regressions in `triggerParsing.test.ts`; validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Tightened `affectedPlayerIds` fallback to player-scoped target fields only (excluding generic `targetIds` noise), and preserved multiplayer targeted stack resolution by explicitly threading selected target bindings into spell/ability stack metadata in `RulesEngineAdapter`; added regressions in `triggerParsing.test.ts` and validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Hardened multi-target semantics by enforcing singleton-only scalar inference for `targetPlayerId`/`targetOpponentId` across trigger normalization and hint adaptation (multi-opponent sets remain relational), plus adapter fallback updates to pass selected target sets while only scalar-binding singleton selections; added multiplayer ambiguity regressions in `RulesEngineAdapter.test.ts` and validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Unified singleton+relational target shaping in stack-resolution compatibility paths by converting raw legacy `targets` into `affectedPlayerIds`/`affectedOpponentIds` before normalization in `resolveStack`; added legacy stack regressions for singleton-target bind + multi-target ambiguity in `RulesEngineAdapter.test.ts`, validated with focused rules-engine suite (`oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Completed broad confidence pass after normalization/targeting hardening by running full rules-engine suite (`vitest run`, 97 files / 2894 tests passing) plus `npm run typecheck --workspace=rules-engine`; no regressions detected beyond focused coverage.
- 2026-02-16: Completed cross-workspace integration check via root `npm run build` (server TypeScript build + client Vite production build succeeded), confirming recent rules-engine hardening does not break monorepo build pipeline.
- 2026-02-16: Hardened draw-trigger event shaping in `checkDrawTriggers` to avoid premature opponent sanitization against the drawing player and to thread explicit drawing-target fields; added regression coverage in `triggersHandler.test.ts` and validated with focused suite (`triggersHandler.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Added pronoun-target support for follow-up templates (`that player`, `that opponent`, plus `he or she`/`they`) in Oracle IR parsing and deterministic selector mapping, with executor regressions and draw-trigger integration validation (`triggersHandler.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded pronoun-target deterministic coverage across additional verbs (`draw`, `discard`, `mill`, `lose_life`) with executor regressions to ensure `that player/that opponent` bindings consistently resolve via selector context; validated with focused suite (`oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`, `RulesEngineAdapter.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded adapter integration coverage for pronoun-target templates by adding full cast/activate -> stack -> resolve regressions for `That player loses 1 life.` in multiplayer, confirming stack metadata/hint propagation resolves pronoun targets correctly; validated with focused suite (`RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Added singleton-safety ambiguity regressions for pronoun templates in adapter stack flows (multi-target `That player ...` spell/ability cases do not auto-bind a first target), validating no first-target collapse under plural target sets; focused suite (`RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`) + `npm run typecheck --workspace=rules-engine` remains green.
- 2026-02-16: Final consolidation checkpoint after pronoun-template and ambiguity hardening: full rules-engine suite rerun clean (`vitest run`, 97 files / 2904 tests) with `npm run typecheck --workspace=rules-engine` also clean.
- 2026-02-16: Extended pronoun-target support to raw damage target resolution (`deals ... to that player/that opponent/he or she/they`) and added deterministic executor regressions, validated with focused suite (`oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`, `RulesEngineAdapter.test.ts`) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Added trigger confidence telemetry fields (`oracleStepsSkipped`, `oracleExecutions`) to `TriggerResult` and regression coverage for applied vs skipped deterministic execution paths in `triggersHandler.test.ts`; focused suite + typecheck green.
- 2026-02-16: Implemented full APNAP ranking with multiplayer turn-order input in `putTriggersOnStack` (beyond active/non-active split), wired turn-order forwarding from `processTriggers`, and added APNAP ordering regression in `triggerParsing.test.ts`; focused suite + typecheck green.
- 2026-02-16: Post-milestone broad verification rerun clean (`vitest run`, 97 files / 2908 tests) with `npm run typecheck --workspace=rules-engine` clean.
- 2026-02-16: Expanded opponent-control intervening-if evaluation in `evaluateOpponentControlCondition` to support count thresholds and additional permanent classes (`X or more creatures/artifacts/enchantments/permanents` plus enchantment/permanent presence), with direct condition regressions added in `triggerParsing.test.ts`; validated by focused suite (`triggerParsing.test.ts`, `triggersHandler.test.ts`, `oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, 367 tests passing) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Further expanded opponent-control condition classes to include `land` and `planeswalker` (including `X or more ...` thresholds) in `evaluateOpponentControlCondition`; added regressions in `triggerParsing.test.ts` and validated with focused suite (`triggerParsing.test.ts`, `triggersHandler.test.ts`, `oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, 368 tests passing) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded deterministic selector phrasing coverage for `its controller` across parser/executor paths (including possessive library forms like `its controller's` and raw damage-target text), with parser + executor regressions (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`); validated via focused suite (`triggerParsing.test.ts`, `triggersHandler.test.ts`, `oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `RulesEngineAdapter.test.ts`, 587 tests passing) + `npm run typecheck --workspace=rules-engine`.
- 2026-02-16: Expanded APNAP sequencing regression matrix with turn-order wrap-around and active-player-missing fallback cases in `triggerParsing.test.ts`, and surfaced trigger telemetry summaries in logs (`[triggers] Oracle auto-execution: executions=..., applied=..., skipped=...`) with regression in `triggersHandler.test.ts`; validated via focused suite + typecheck, then full-suite confidence pass clean (`vitest run`, 97 files / 2914 tests) with `npm run typecheck --workspace=rules-engine` clean.
- 2026-02-16: Completed non-player selector normalization parity hardening by normalizing battlefield permanent controller IDs in object selector filtering (`you` / `opponents`) and rejecting malformed controller IDs for controller-scoped matches; added regressions in `oracleIRExecutor.test.ts` (whitespace controller IDs + malformed-controller exclusion) and validated with focused suite (`RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `triggersHandler.test.ts`, 373 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite confidence rerun clean (`vitest run`, 97 files / 2916 tests).
- 2026-02-16: Added missing support for previously unsupported multi-sentence combat-damage trigger effects by preserving full same-line trigger effect text in `parseTriggeredAbilitiesFromText` (instead of truncating at first period), enabling relational exile-top trigger execution in `dealCombatDamage` adapter flow; added regressions in `triggerParsing.test.ts` and `RulesEngineAdapter.test.ts`, validated with focused suite (`triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggersHandler.test.ts`, 375 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2918 tests).
- 2026-02-16: Expanded missing trigger-parser support further to preserve multiline trigger effect bodies until the next trigger header (while still splitting adjacent trigger headers correctly), covering newline-separated effect continuations in real oracle layouts; added regressions in `triggerParsing.test.ts`, validated with focused suite (`triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `oracleIRExecutor.test.ts`, `triggersHandler.test.ts`, 377 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2920 tests).
- 2026-02-16: Added deterministic `its owner` selector support across parser/executor paths (`parsePlayerSelector`, exile-until subject parsing, possessive library source mapping, and raw damage-target resolution), enabling context-bound player resolution for owner-referential phrasings; updated parser expectation and added executor regression in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 594 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2921 tests).
- 2026-02-16: Added missing deterministic coverage for the `its owner may exile ... from the top of their library` parser branch (including possessive source variants in create+exile split parsing), so owner-referential exile-top templates bind `target_player` consistently instead of falling through to unknown; added parser regression in `oracleIRParser.test.ts` and executor regression in `oracleIRExecutor.test.ts`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 596 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2923 tests).
- 2026-02-16: Closed residual owner-possessive gaps in the large exile-top parsing path by adding `its owner's`/`its controller's` source support consistently across direct exile, variable-amount exile, and `put ... into exile` variants (including contextual `each of those opponents` branch adjacency); added regression in `oracleIRParser.test.ts` for `that many ... from the top of its owner's library`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 597 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2924 tests).
- 2026-02-16: Expanded deterministic antecedent-controller phrasing support to include `that creature's controller` / `that permanent's controller` / `that card's controller` across parser selector mapping, impulse-exile subject parsing (including exile-until variants), and raw damage-target resolution in executor; added parser regression in `oracleIRParser.test.ts` and executor regression in `oracleIRExecutor.test.ts`, validated with focused suite (`oracleIRParser.test.ts`, `oracleIRExecutor.test.ts`, `triggerParsing.test.ts`, `RulesEngineAdapter.test.ts`, `triggersHandler.test.ts`, 599 tests passing) + `npm run typecheck --workspace=rules-engine`, then full-suite pass clean (`vitest run`, 97 files / 2926 tests).
- 2026-02-16: Completed antecedent-owner phrasing parity by adding deterministic support for `that creature's owner` / `that permanent's owner` / `that card's owner` across parser selector mapping, impulse-exile subject parsing branches, and executor raw damage-target resolution; added parser regression in `oracleIRParser.test.ts` and executor regression in `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2928 tests).
- 2026-02-16: Expanded antecedent phrase regression coverage to include additional deterministic variants already supported in code (`that creature's owner`, `that card's owner`, `that card's controller`) across parser and raw damage-target executor paths; added parser and executor regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2932 tests).
- 2026-02-16: Closed the remaining complementary antecedent regression pair by adding parser coverage for `that card's owner` impulse-exile subject mapping and executor raw-damage target coverage for `that card's controller`; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2934 tests).
- 2026-02-16: Generalized antecedent owner/controller selector handling from fixed noun lists to `that <object>'s owner/controller` pattern matching across parser selector mapping, impulse-exile subject branches, and executor raw damage target resolution; added regressions for `that artifact's controller` (`oracleIRParser.test.ts`) and `that enchantment's owner` (`oracleIRExecutor.test.ts`), validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2936 tests).
- 2026-02-16: Added deterministic pronoun-synonym support for `him or her` by normalizing it to existing `he or she` parser paths and extending raw damage target resolution to bind it as `target_player`; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2938 tests).
- 2026-02-16: Added missing relational raw-damage target support for `each of those opponents` in executor damage target resolution (binding to `each_of_those_opponents` selector context), with regression coverage in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2939 tests).
- 2026-02-16: Extended mixed deterministic damage target parsing to support relational `each of those opponents` player groups (e.g. `each creature and each of those opponents`) by threading `each_of_those_opponents` through mixed-target execution; added focused regression in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2940 tests).
- 2026-02-16: Added relational selector alias support for bare `those opponents` / `all of those opponents` across parser normalization, player-selector mapping, raw damage target resolution, and mixed deterministic damage target parsing; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2942 tests).
- 2026-02-16: Closed possessive relational alias gap in exile-top parsing by supporting `those opponents'` / `all of those opponents'` source forms (plus `each of those opponents'`) in the primary single-clause and impulse-exile parser branches, enabling deterministic `each_of_those_opponents` binding for both `Exile ... of ... libraries` and `Put ... into exile` templates; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2944 tests).
- 2026-02-16: Extended face-down combined look+exile parsing to accept relational possessive source aliases (`those opponents'` / `all of those opponents'` / `each of those opponents'`) and map them to `each_of_those_opponents`, enabling deterministic relational execution for templates like `Look at the top card of those opponents' libraries and exile those cards face down`; added regressions in `oracleIRParser.test.ts` + `oracleIRExecutor.test.ts`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2946 tests).
- 2026-02-16: Generalized two-clause face-down look+exile parsing to support both legacy singular (`top card ... exile it`) and quantified/plural object forms (`top N cards ... exile those cards`), while adding relational possessive source aliases (`those opponents'` / `all of those opponents'` / `each of those opponents'`) with `each_of_those_opponents` binding; added parser + executor regressions for `Look at the top card of those opponents' libraries, then exile those cards face down ...`, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2948 tests).
- 2026-02-16: Added explicit alias regression coverage for `all of those opponents` / `all of those opponents'` across selector parsing, possessive exile-top parsing, and executor relational resolution (`deal_damage` + `exile_top`) to lock parity with existing `those opponents` handling; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2952 tests).
- 2026-02-16: Reduced parser drift risk by centralizing relational alias detection into `isThoseOpponentsSelector` / `isThoseOpponentsPossessiveSource` helpers and replacing duplicated inline `startsWith(...)` chains across exile-top and face-down parsing branches (no behavior change intended); validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2952 tests).
- 2026-02-16: Extended relational alias regression coverage to include the compact `all those opponents` player phrase and mixed-target phrasing `each creature and all of those opponents` in executor deterministic damage paths, plus parser selector coverage for `all those opponents`; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2955 tests).
- 2026-02-17: Extended parser support for exile-until subject aliases by accepting relational variants (`each of those opponents` / `those opponents` / `all of those opponents` / `all those opponents`) in the `... exiles cards from the top of their library until ...` branch and mapping them to `each_of_those_opponents`; added parser regressions for `each of those opponents` + `all those opponents` exile-until templates, validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2957 tests).
- 2026-02-17: Completed exile-until alias parity coverage by adding parser regressions for the remaining relational subject variants (`those opponents` and `all of those opponents`) in `... exiles cards from the top of their library until ...` templates, ensuring all supported alias forms are lock-tested; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2959 tests).
- 2026-02-17: Reduced executor drift risk by centralizing relational alias checks into `isThoseOpponentsSelector(...)` and replacing duplicated inline string checks in deterministic damage-target parsing (`resolvePlayersFromDamageTarget`, `parseDeterministicMixedDamageTarget`) with no intended behavior change; validated with focused suites (`vitest test/oracleIRParser.test.ts`, `vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2959 tests).
- 2026-02-17: Expanded deterministic raw damage-target support to treat `defending player` / `the defending player` as `target_opponent` in `resolvePlayersFromDamageTarget`, with focused regressions added in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2961 tests).
- 2026-02-17: Extended mixed deterministic damage-target parsing/execution to treat `defending player` / `the defending player` (and context-bound singleton aliases like `that player` / `that opponent`) as valid player parts when combined with battlefield selectors (for example, `each creature and defending player`), with regressions added in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2963 tests).
- 2026-02-17: Added explicit mixed-target regression coverage for context-bound singleton player aliases `that player` and `that opponent` (e.g., `each creature and that player`) in `oracleIRExecutor.test.ts` to lock deterministic mixed parsing/execution parity with direct damage-target handling; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2965 tests).
- 2026-02-17: Closed non-damage defending-player gap by extending player-selector parsing and gain/lose-life subject matching to accept `defending player` / `the defending player` as `target_opponent`, with executor regressions for `Defending player loses 1 life.` and `The defending player loses 1 life.` in `oracleIRExecutor.test.ts`; validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2967 tests).
- 2026-02-17: Extended draw subject parsing to accept `defending player` / `the defending player` in deterministic player-subject draw templates, enabling target-opponent context binding for `Defending player draws a card.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2969 tests).
- 2026-02-17: Extended mill subject parsing to accept `defending player` / `the defending player` in deterministic player-subject mill templates, enabling target-opponent context binding for `Defending player mills a card.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2971 tests).
- 2026-02-17: Extended discard subject parsing to accept `defending player` / `the defending player` across deterministic discard patterns (`discards ...`, `discards ... hand`, `discards all cards in ... hand`), enabling target-opponent context binding for `Defending player discards a card.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2973 tests).
- 2026-02-17: Extended `scry`/`surveil` subject parsing to accept `defending player` / `the defending player` in deterministic player-subject templates, and added executor regressions that validate target-opponent context binding in no-choice empty-library cases (`Defending player scries 1.` / `The defending player surveils 1.`); validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2975 tests).
- 2026-02-17: Extended deterministic `add_mana` subject parsing to accept `defending player` / `the defending player`, enabling target-opponent context binding for templates like `Defending player adds {G}.`; added executor regressions in `oracleIRExecutor.test.ts` and validated with focused parser+executor suites (`vitest test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2977 tests).
- 2026-02-17: Extended deterministic `sacrifice` subject parsing to accept `defending player` / `the defending player`, enabling target-opponent context binding for templates like `Defending player sacrifices a creature.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2979 tests).
- 2026-02-17: Extended deterministic `create_token` subject parsing to accept `defending player` / `the defending player` in both single-token and multi-token parser branches, enabling target-opponent context binding for templates like `Defending player creates a Treasure token.`; added executor regressions in `oracleIRExecutor.test.ts`, validated with focused suite (`vitest test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2981 tests).
- 2026-02-17: Extended impulse exile subject parsing to accept `defending player` / `the defending player` in third-person `... may exile ... from the top of their library` and `... exiles cards from the top ... until ...` branches (including both primary and pending-upgrade parser paths), with parser regressions in `oracleIRParser.test.ts`; validated with focused parser+executor suites (`vitest test/oracleIRParser.test.ts test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2983 tests).
- 2026-02-17: Added possessive-source normalization for `the defending player's` phrasing in clause preprocessing (mapped to `target opponent's`) so deterministic exile-top/impulse templates bind `target_opponent` across parser paths without branch drift; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2985 tests).
- 2026-02-17: Extended subject-order deterministic exile-top parsing to accept `defending player` / `the defending player` in `... exiles the top card(s) of their library` and `... puts the top card(s) of their library into exile` branches (in both primary and fallback parse paths), and switched those branch mappings to `parsePlayerSelector(...)` to reduce selector drift; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2987 tests).
- 2026-02-17: Closed standalone face-down relational alias drift in `tryParseExileTopOnly` by extending `look at the top ... and exile ... face down` source matching to include `each of those opponents'` / `those opponents'` / `all of those opponents'` / `all those opponents'` and mapping those forms to `each_of_those_opponents`; added parser + executor regressions for the standalone no-permission template in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2989 tests).
- 2026-02-17: Closed split-clause face-down impulse drift by expanding the 2-clause `look at the top card ...` + `then exile ... face down` parser path to accept relational possessive aliases (`each of those opponents'` / `those opponents'` / `all of those opponents'` / `all those opponents'`) and plural second-clause refs (`them` / `those cards` / `the cards`), mapping relational forms to `each_of_those_opponents`; added parser + executor regressions for the split-clause template in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2991 tests).
- 2026-02-17: Extended the split-clause face-down impulse path to support quantified look clauses (`look at the top N cards ... . Then exile those cards face down ...`) while preserving deterministic selector binding for target-opponent and relational sources; added parser + executor regressions for the top-two split-clause template in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2993 tests).
- 2026-02-17: Added standalone no-permission regression coverage for split-clause quantified face-down exile (`look at the top N cards ... . Then exile those cards face down.`) to lock parity between `impulse_exile_top` and `exile_top` parsing/execution paths; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2995 tests).
- 2026-02-17: Expanded split-clause top-N look+exile parsing parity to also accept no-face-down second clauses (`Then exile those cards.`) in both impulse-upgrade and standalone no-permission paths, preventing parser drift between `impulse_exile_top` and `exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`vitest run test/oracleIRParser.test.ts`, `vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`vitest run`, 97 files / 2999 tests).
- 2026-02-17: Closed remaining single-clause look+exile drift by allowing combined templates to parse with or without `face down` in both impulse-upgrade (`look ... and exile ... . You may play ...`) and standalone no-permission (`look ... and exile ...`) paths, preserving selector parity across target-opponent and relational possessive sources; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3003 tests).
- 2026-02-17: Closed generic player-subject drift by extending deterministic effect-clause subject matching (draw/add_mana/scry/surveil/discard/mill/gain_life/lose_life/create_token/sacrifice and multi-create prefix) to accept `its owner` / `its controller` / `that <object>'s owner|controller`, aligning clause regexes with existing `parsePlayerSelector` support; added parser + executor regressions for `That creature's owner draws a card.` in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3005 tests).
- 2026-02-17: Closed cross-ability loose impulse upgrade drift for owner/controller third-person permission clauses by allowing global loose permission upgrades to apply to single-card `exile_top` seeds (amount = 1) when permission text is singular (`it` / `that card` / equivalent), enabling templates like `Target player exiles the top card ... Its owner may cast it this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3007 tests).
- 2026-02-17: Extended cross-ability loose impulse upgrade parity for fixed plural exile-top seeds by allowing global loose permission upgrades to apply to numeric `exile_top` amounts greater than 1 when permission text is plural-referential (`them` / `those cards` / exiled-cards variants), enabling templates like `Target player exiles the top two cards ... Its owner may cast them this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3009 tests).
- 2026-02-17: Closed loose-impulse phrasing parity gap for `spell(s) they exiled this way` by extending global loose permission object references and plural-upgrade gating to recognize those variants, enabling cross-ability owner/controller templates like `Target player exiles the top two cards ... Its owner may cast spells they exiled this way this turn.` to deterministically upgrade/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3011 tests).
- 2026-02-17: Closed remaining single-card loose-upgrade gating gap by allowing singular cross-ability permissions that reference `the card they exiled this way` / `the spell they exiled this way` to upgrade numeric-1 `exile_top` seeds (owner/controller third-person forms), enabling templates like `Target player exiles the top card ... Its owner may cast the spell they exiled this way this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3013 tests).
- 2026-02-17: Closed cross-ability loose duration-phrase drift by extending global loose permission parsing to accept `until the end of this turn` / `until the end of that turn` (in addition to end-of-turn short forms), enabling templates like `Target player exiles the top card ... Its owner may cast it until the end of this turn.` to deterministically parse/execute as `impulse_exile_top`; added parser + executor regressions in `oracleIRParser.test.ts` and `oracleIRExecutor.test.ts`, validated with focused suites (`npx vitest run test/oracleIRParser.test.ts`, `npx vitest run test/oracleIRExecutor.test.ts`), `npm run typecheck --workspace=rules-engine`, and full-suite pass clean (`npm run test --workspace=rules-engine -- --run`, 97 files / 3015 tests).
